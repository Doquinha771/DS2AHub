<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>DS2A Hub Refatorado — Completo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- CSP (compatível com arquivo único + YouTube nocookie) -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' data:; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; script-src 'self' 'unsafe-inline'; frame-src https://www.youtube-nocookie.com https://www.youtube.com; connect-src 'self'; media-src 'self' data:;" />
  <meta name="description" content="Hub central DS2A para aulas, trabalhos, calendário e materiais." />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg-start: #0d1117;
      --bg-end: #010409;
      --glass-bg: rgba(22,27,34,.6);
      --glass-border: rgba(139,148,158,.2);
      --text-primary:#f0f6fc; --text-secondary:#8b949e;
      --accent-1:#58A6FF; --accent-2:#1F6FEB; /* será trocado semanalmente */
      --accent-gradient: linear-gradient(135deg, var(--accent-1), var(--accent-2));
      --success:#3FB950; --warning:#D29922; --danger:#F85149; --holiday:#A371F7;
      --card-shadow: 0 16px 40px rgba(0,0,0,.4);
      --radius-lg:16px; --radius-md:10px; --glass-blur:16px; --t: .35s;
      --cor-geografia:#3FB950; --cor-quimica:#BF39A1; --cor-ingles:#D29922; --cor-fisica:#F85149; --cor-carreira:#58A6FF; --cor-portugues:#A371F7; --cor-historia:#E3B341; --cor-biologia:#2AAA8A; --cor-redes:#F77825; --cor-matematica:#1F6FEB; --cor-sociologia:#DB61A2; --cor-processos:#3FB950; --cor-logica:#A371F7; --cor-edfisica:#F85149; --cor-default:#8b949e;
    }
    *{box-sizing:border-box}
    html{scroll-behavior:smooth}
    body{margin:0;min-height:100vh;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background: radial-gradient(1200px 1200px at 20% -10%, rgba(88,166,255,.12), transparent 60%), radial-gradient(1200px 1200px at 120% 10%, rgba(31,111,235,.12), transparent 60%), linear-gradient(180deg,var(--bg-start),var(--bg-end));color:var(--text-primary);display:flex;justify-content:center;padding:18px}
    .app{width:100%;max-width:980px}
    h1{margin:0;font-size:1.8rem;font-weight:800;background:var(--accent-gradient);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}
    .header{display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;gap:12px;margin-bottom:10px}
    .tabs{display:flex;gap:8px;background:var(--glass-bg);backdrop-filter:blur(var(--glass-blur));-webkit-backdrop-filter:blur(var(--glass-blur));padding:6px;border-radius:999px;border:1px solid var(--glass-border)}
    .tab{padding:8px 16px;border:none;border-radius:999px;background:transparent;color:var(--text-secondary);font-weight:700;cursor:pointer;transition:.2s}
    .tab:hover{background:rgba(255,255,255,.08);color:var(--text-primary)}
    .tab.active{background:var(--accent-2);color:#fff;box-shadow:0 6px 22px rgba(31,111,235,.35)}
    .theme-toggle,.relax-toggle{width:40px;height:40px;border-radius:50%;border:1px solid var(--glass-border);background:var(--glass-bg);color:var(--text-primary);display:grid;place-items:center;cursor:pointer;transition:.2s}
    .theme-toggle:hover,.relax-toggle:hover{transform:translateY(-2px);background:var(--accent-1);color:#010409}
    .topbar{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;color:var(--text-secondary);margin:8px 0 14px}
    .progress-wrap{flex:1;min-width:220px;background:rgba(255,255,255,.06);border:1px solid var(--glass-border);border-radius:999px;overflow:hidden;height:10px;position:relative}
    .progress-bar{height:100%;width:0;background:var(--accent-gradient);transition:width var(--t)}
    .progress-label{font-size:.8rem;margin-left:8px}
    .announcement{background:linear-gradient(135deg, rgba(88,166,255,.12), rgba(31,111,235,.18));border:1px solid var(--glass-border);border-radius:var(--radius-lg);padding:18px;position:relative;overflow:hidden}
    .announcement h2{margin:0 0 6px;font-size:1.05rem}
    .close-x{position:absolute;top:10px;right:10px;width:28px;height:28px;border-radius:50%;border:0;background:rgba(255,255,255,.08);color:var(--text-primary);cursor:pointer}
    .reactions{margin-top:12px;display:flex;gap:8px}
    .react{border:1px solid var(--glass-border);background:rgba(255,255,255,.06);border-radius:999px;padding:6px 10px;cursor:pointer}
    .react.active{background:var(--accent-1);color:#010409;border-color:var(--accent-1)}

    /* --- Animações e Transições --- */
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
    .card { animation: fadeInUp 0.6s ease-out both; }
    section[role="tabpanel"] { display: none; }
    section[role="tabpanel"].active { display: block; animation: fadeInUp 0.5s ease-out; }
    .is-past { text-decoration: line-through; opacity: 0.65; }
    .important-note { font-size: .8rem; color: var(--warning); margin-bottom: 5px; border: 1px solid var(--warning); padding: 5px; border-radius: 8px; background: rgba(210, 153, 34, 0.1); }
    #dayEvents.reloading > .event { animation: fadeInUp 0.5s ease-out both; }
    #dayEvents.reloading > .event:nth-child(2) { animation-delay: .08s; }
    #dayEvents.reloading > .event:nth-child(3) { animation-delay: .16s; }
    
    .card{background:var(--glass-bg);border:1px solid var(--glass-border);border-radius:var(--radius-lg);padding:18px;box-shadow:var(--card-shadow);backdrop-filter:blur(var(--glass-blur));-webkit-backdrop-filter:blur(var(--glass-blur))}
    .grid{display:grid;gap:16px}
    .grid.auto{grid-template-columns:repeat(auto-fit,minmax(240px,1fr))}

    .calendar{padding:14px;border-radius:var(--radius-md);background:rgba(255,255,255,.04)}
    .cal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .cal-head button{width:32px;height:32px;border-radius:50%;border:1px solid var(--glass-border);background:rgba(255,255,255,.06);color:var(--text-primary);cursor:pointer}
    .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
    .cal-day,.cal-date{text-align:center;padding:8px 4px;border-radius:8px;font-size:.85rem}
    .cal-day{color:var(--text-secondary);font-weight:700}
    .cal-date{cursor:pointer;color:var(--text-primary);position:relative}
    .cal-date:hover{background:rgba(255,255,255,.08)}
    .cal-date.today{background:var(--accent-gradient);color:#fff}
    .cal-date.selected{outline:2px solid var(--accent-1)}
    .cal-date.has-events::after{content:'';position:absolute;bottom:4px;left:50%;transform:translateX(-50%);width:5px;height:5px;border-radius:50%;background:var(--accent-1)}
    .cal-date.is-holiday::after{background:var(--holiday)}
    .event{display:flex;gap:8px;align-items:center;background:rgba(255,255,255,.06);padding:10px;border-radius:10px}
    .etype{font-weight:700;font-size:.75rem;padding:4px 8px;border-radius:7px;color:#010409}
    .etype.Prova{background:var(--danger)}
    .etype.Trabalho{background:var(--warning)}
    .etype.Feriado{background:var(--holiday)}

    /* --- Aulas: cards interativos --- */
    .lessons-controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
    select, input[type="text"], .btn{background:rgba(255,255,255,.08);border:1px solid var(--glass-border);color:var(--text-primary);border-radius:10px;padding:8px 10px}
    .btn{cursor:pointer}
    .summary{display:flex;gap:10px;align-items:center;color:var(--text-secondary);margin:8px 0}
    .badge{font-size:.8rem;font-weight:700;padding:3px 8px;border-radius:8px;background:rgba(255,255,255,.08);align-self:flex-start}
    .lesson-card { background: rgba(255, 255, 255, .06); border: 1px solid var(--glass-border); border-radius: 12px; padding: 12px; display: flex; flex-direction: column; gap: 8px; cursor: pointer; transition: transform .3s ease, box-shadow .3s ease; min-height: 90px; }
    .lesson-card:hover { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0,0,0,.25); }
    .lesson-header { display: flex; justify-content: space-between; align-items: center; }
    .notes-prompt { color: var(--text-secondary); font-size: .8rem; margin-top: auto; }
    .lesson-notes { display: none; margin-top: 8px; }
    .lesson-card.is-open .lesson-notes { display: block; animation: fadeInUp .45s; cursor: default; }
    .lesson-card.is-open .notes-prompt { display: none; }
    .lesson-notes textarea { width: 100%; background:rgba(0,0,0,.2); border:1px solid var(--glass-border); color:var(--text-primary); border-radius:8px; padding:8px; margin-bottom: 8px; resize: vertical; }
    .save-note { width: 100%; }

    /* Trabalhos: timeline */
    .timeline{position:relative;padding-left:12px}
    .t-item{position:relative;margin:8px 0;padding:10px;border:1px solid var(--glass-border);border-radius:10px;background:rgba(255,255,255,.05)}
    .t-item.pending::before{content:'';position:absolute;left:-6px;top:16px;width:10px;height:10px;border-radius:50%;background:var(--warning)}
    .t-item.done::before{content:'';position:absolute;left:-6px;top:16px;width:10px;height:10px;border-radius:50%;background:var(--success)}
    .tbar{height:8px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden}
    .tbar > span{display:block;height:100%;width:0;background:var(--accent-gradient);transition:width var(--t)}
    .days{font-size:.8rem;color:var(--text-secondary)}

    /* Relax: estrelas + player */
    #stars{position:fixed;inset:0;pointer-events:none;opacity:0;transition:opacity .6s}
    #relaxPanel{display:none;margin-top:10px}
    .relax-on #stars{opacity:.9}
    .relax-on #relaxPanel{display:block}

    /* Busca rápida calendário */
    .searchbox{position:relative}
    .results{position:absolute;z-index:10;left:0;right:0;background:var(--glass-bg);border:1px solid var(--glass-border);border-radius:10px;max-height:160px;overflow:auto}
    .res{padding:8px;cursor:pointer}
    .res:hover{background:rgba(255,255,255,.08)}

    /* Materiais */
    .materials{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(240px,1fr))}
    .mat{display:flex;gap:12px;align-items:center;background:rgba(255,255,255,.06);padding:12px;border-radius:12px;border:1px solid var(--glass-border)}
    .mat .icon{font-size:1.4rem;background:var(--accent-gradient);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .link{color:var(--accent-1);text-decoration:underline}

    /* Notificações */
    .notify{position:fixed;top:12px;left:50%;transform:translateX(-50%);display:flex;gap:8px;flex-direction:column;z-index:50}
    .note{background:rgba(0,0,0,.8);padding:10px 14px;border-radius:10px;border:1px solid var(--glass-border)}

    @media (max-width:768px){
      .grid.auto{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <canvas id="stars"></canvas>
  <div class="notify" id="notify"></div>

  <div class="app" id="app">
    <header class="header">
      <h1>DS2A Hub</h1>
      <div style="display:flex;gap:10px;align-items:center">
        <nav class="tabs" role="tablist" aria-label="Navegação Principal">
          <button class="tab active" data-tab="aulas">Aulas</button>
          <button class="tab" data-tab="trabalhos">Trabalhos</button>
          <button class="tab" data-tab="materiais">Materiais</button>
        </nav>
        <button class="relax-toggle" id="relaxBtn" title="Modo Relax">🌙</button>
        <button class="theme-toggle" id="themeBtn" title="Alternar tema">☀️</button>
      </div>
    </header>

    <div class="topbar">
      <div class="progress-wrap" title="Progresso do bimestre"><div class="progress-bar" id="bimBar"></div></div>
      <span class="progress-label" id="bimLabel">0%</span>
      <span id="quote"></span>
    </div>

    <section class="announcement card" id="announce"></section>

    <main>
      <!-- AULAS -->
      <section class="card active" id="tab-aulas" role="tabpanel">
        <div class="grid" style="grid-template-columns:1.1fr .9fr;align-items:start">
          <div>
            <div class="searchbox" style="margin-bottom:10px">
              <input id="searchCal" type="text" placeholder="Buscar evento/data (ex: Prova, 2025-09-04)" style="width:100%" />
              <div class="results" id="results"></div>
            </div>
            <div class="calendar" id="calendar"></div>
            <div id="dayEvents" style="margin-top:10px" class="grid"></div>
          </div>
          <div>
            <div class="lessons-controls">
              <select id="viewMode">
                <option value="hoje">Hoje</option>
                <option value="semana">Semana</option>
              </select>
              <select id="subjectFilter"><option value="">Todas as matérias</option></select>
              <button class="btn" id="clearNotes">Limpar anotações</button>
            </div>
            <div class="summary" id="lessonsSummary">—</div>
            <div class="grid auto" id="lessons"></div>
          </div>
        </div>
      </section>

      <!-- TRABALHOS -->
      <section class="card" id="tab-trabalhos" role="tabpanel">
        <h2 style="margin:0 0 10px">Timeline de prazos</h2>
        <div class="timeline" id="tlPending"></div>
        <h2 style="margin:16px 0 10px">Concluídos</h2>
        <div class="grid auto" id="tlDone"></div>
        <div id="relaxPanel" class="card">
          <h3 style="margin:0 0 8px">Modo Relax (Lofi)</h3>
          <div style="position:relative;padding-top:56.25%">
            <iframe title="Lofi" src="https://www.youtube-nocookie.com/embed/jfKfPfyJRdk?autoplay=0&controls=1" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen style="position:absolute;inset:0;width:100%;height:100%;border:0;border-radius:12px"></iframe>
          </div>
        </div>
      </section>

      <!-- MATERIAIS -->
      <section class="card" id="tab-materiais" role="tabpanel">
        <h2 style="margin:0 0 12px">Ferramentas & Recursos</h2>
        <div class="materials" id="materials"></div>
        <div class="grid" style="grid-template-columns:1fr .9fr;margin-top:14px">
          <div class="card">
            <h3 style="margin:0 0 8px">Pesquisa rápida</h3>
            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
              <select id="engine"><option value="scholar">Google Acadêmico</option><option value="youtube">YouTube</option></select>
              <input id="qExt" type="text" placeholder="Digite o termo..." style="flex:1" />
              <button class="btn" id="goExt">Buscar</button>
            </div>
            <div class="card">
              <h3 style="margin:0 0 8px">Link Rápido</h3>
              <div style="display:flex;gap:8px"><input id="quick" type="text" placeholder="Cole um link útil..." style="flex:1" /><button id="saveQuick" class="btn">Salvar</button></div>
              <div id="quickList" style="margin-top:8px"></div>
            </div>
          </div>
          <div class="card">
            <h3 style="margin:0 0 8px">Currículo base (.txt)</h3>
            <p class="muted" style="color:var(--text-secondary);margin:0 0 8px">Baixe e edite no seu editor favorito.</p>
            <button class="btn" id="cvBtn">Baixar currículo.txt</button>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // ===================== 1) DADOS =====================
    const appData = {
      bimesterStartDate: '2025-08-01',
      bimesterEndDate:   '2025-09-30',
      announcement: { id:'anuncio-setembro', title:'Foco total em Setembro!', message:'Trabalho de Inglês concluído com sucesso! Prepare-se para a entrega de Educação Física na próxima semana. Vamos fechar o bimestre com chave de ouro!' },
      lessons: {
        1:{ day:'Segunda-feira', subjects:[
          { name:'Geografia', color:'geografia' }, { name:'Química', color:'quimica' }, { name:'Inglês', color:'ingles' }, { name:'Física', color:'fisica' }, { name:'Carreira', count:3, color:'carreira', room:'Lab 2' }
        ]},
        2:{ day:'Terça-feira', subjects:[
          { name:'Português', color:'portugues' }, { name:'História', color:'historia' }, { name:'Biologia', color:'biologia' }, { name:'Geografia', color:'geografia' }, { name:'Redes', count:3, color:'redes', room:'Lab 1' }
        ]},
        3:{ day:'Quarta-feira', subjects:[
          { name:'Matemática', count:2, color:'matematica' }, { name:'Biologia', color:'biologia' }, { name:'Sociologia', color:'sociologia' }, { name:'Processos', count:3, color:'processos', room:'Oficina' }
        ]},
        4:{ day:'Quinta-feira', subjects:[
          { name:'Matemática', color:'matematica' }, { name:'Inglês', color:'ingles' }, { name:'Ed. Física', color:'edfisica' }, { name:'Lógica', count:2, color:'logica' }, { name:'Matemática', color:'matematica' }, { name:'Português', color:'portugues' }
        ]},
        5:{ day:'Sexta-feira', subjects:[
          { name:'Sociologia', color:'sociologia' }, { name:'Lógica', count:2, color:'logica' }, { name:'Física', color:'fisica' }, { name:'Português', color:'portugues' }, { name:'História', color:'historia' }, { name:'Química', color:'quimica' }
        ]}
      },
      assignments: [
        { title:'Educação Física', status:'pending', date:'2025-09-04' },
        { title:'Carreira', status:'pending', date:'2025-09-01' },
        { title:'Inglês', status:'done',    date:'2025-08-28' },
        { title:'Física', status:'done' }
      ],
      events: {
        '2025-09-01':[ { type:'Trabalho', title:'Entrega do Trabalho de Carreira' } ],
        '2025-09-04':[ { type:'Trabalho', title:'Entrega do Trabalho de Educação Física' } ],
        '2025-08-28':[ { type:'Prova', title:'Prova de Matemática' }, { type:'Trabalho', title:'Entrega do Trabalho de Inglês' } ],
        '2025-09-07':[ { type:'Feriado', title:'Independência do Brasil' } ],
        '2025-10-12':[ { type:'Feriado', title:'Nossa Senhora Aparecida' } ],
        '2025-11-02':[ { type:'Feriado', title:'Finados' } ],
        '2025-11-15':[ { type:'Feriado', title:'Proclamação da República' } ],
        '2025-11-20':[ { type:'Feriado', title:'Dia da Consciência Negra' } ],
        '2025-12-25':[ { type:'Feriado', title:'Natal' } ]
      },
      materials: [
        { icon:'🎨', title:'Figma', desc:'Design de interfaces e protótipos.' },
        { icon:'💻', title:'VS Code', desc:'Editor de código.' },
        { icon:'📦', title:'GitHub', desc:'Hospedagem de código.' },
        { icon:'🧠', title:'Stack Overflow', desc:'Comunidade para dúvidas.' }
      ],
      quotes:[
        'A disciplina é a ponte entre metas e realizações.',
        'Comece onde você está. Use o que você tem. Faça o que você pode.',
        'O sucesso é a soma de pequenos esforços repetidos dia após dia.',
        'Acredite em si mesmo e tudo será possível.',
        'O futuro pertence a quem acredita na beleza dos seus sonhos.'
      ],
      colorPalettes:[
        { accent1:'#58A6FF', accent2:'#1F6FEB' },
        { accent1:'#3FB950', accent2:'#2AAA8A' },
        { accent1:'#BF39A1', accent2:'#A371F7' },
        { accent1:'#F77825', accent2:'#D29922' }
      ]
    };

    // ===================== 2) ESTADO & ELEMENTOS =====================
    const el = {
      tabs: document.querySelectorAll('.tab'),
      panels: {
        aulas: document.getElementById('tab-aulas'),
        trabalhos: document.getElementById('tab-trabalhos'),
        materiais: document.getElementById('tab-materiais'),
      },
      stars: document.getElementById('stars'),
      relaxBtn: document.getElementById('relaxBtn'),
      themeBtn: document.getElementById('themeBtn'),
      announce: document.getElementById('announce'),
      notify: document.getElementById('notify'),
      quote: document.getElementById('quote'),
      bimBar: document.getElementById('bimBar'),
      bimLabel: document.getElementById('bimLabel'),
      // aulas
      calendar: document.getElementById('calendar'),
      searchCal: document.getElementById('searchCal'),
      results: document.getElementById('results'),
      dayEvents: document.getElementById('dayEvents'),
      lessons: document.getElementById('lessons'),
      lessonsSummary: document.getElementById('lessonsSummary'),
      viewMode: document.getElementById('viewMode'),
      subjectFilter: document.getElementById('subjectFilter'),
      clearNotes: document.getElementById('clearNotes'),
      // trabalhos
      tlPending: document.getElementById('tlPending'),
      tlDone: document.getElementById('tlDone'),
      relaxPanel: document.getElementById('relaxPanel'),
      // materiais
      materials: document.getElementById('materials'),
      engine: document.getElementById('engine'),
      qExt: document.getElementById('qExt'),
      goExt: document.getElementById('goExt'),
      quick: document.getElementById('quick'),
      saveQuick: document.getElementById('saveQuick'),
      quickList: document.getElementById('quickList'),
      cvBtn: document.getElementById('cvBtn'),
      app: document.getElementById('app')
    };

    const state = {
      today: new Date(),
      selected: new Date(),
      month: (new Date()).getMonth(),
      year: (new Date()).getFullYear(),
    };

    // ===================== 3) UTIL =====================
    const pad = (n) => n.toString().padStart(2,'0');
    const toISO = (d) => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;

    // Semana/cores
    function getWeekNumber(d){
      d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
      return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
    }
    function applyWeeklyPalette(){
      const week = getWeekNumber(new Date());
      const p = appData.colorPalettes[week % appData.colorPalettes.length];
      document.documentElement.style.setProperty('--accent-1', p.accent1);
      document.documentElement.style.setProperty('--accent-2', p.accent2);
    }

    // Tema dinâmico por horário
    function autoTheme(){
      const h = new Date().getHours();
      if(h >= 6 && h < 18){ // manhã/tarde
        document.body.classList.remove('neon');
        document.body.style.filter = 'none';
        el.themeBtn.textContent = '🌙';
      } else if (h >= 18 && h < 23){ // noite
        document.body.classList.remove('neon');
        document.body.style.filter = 'brightness(0.95)';
        el.themeBtn.textContent = '☀️';
      } else { // madrugada: neon gamer
        document.body.classList.add('neon');
        document.body.style.filter = 'none';
        el.themeBtn.textContent = '⚡';
      }
    }

    // alternância manual claro/escuro/neon (ciclo)
    el.themeBtn.addEventListener('click', () => {
      if(document.body.classList.contains('neon')){
        document.body.classList.remove('neon');
        document.body.style.filter = 'none';
      } else if (document.body.style.filter){
        document.body.style.filter = '';
      } else {
        document.body.style.filter = 'brightness(0.95)';
      }
    });

    // Estrelas (modo relax)
    function drawStars(){
      const c = el.stars, ctx = c.getContext('2d');
      const DPR = Math.max(1, window.devicePixelRatio||1);
      c.width = innerWidth*DPR; c.height = innerHeight*DPR; c.style.width = '100%'; c.style.height='100%';
      const stars = Array.from({length:200},()=>({ x: Math.random()*c.width, y: Math.random()*c.height, r: Math.random()*1.2*DPR, s: Math.random()*0.6+0.2 }));
      let t=0; (function anim(){
        ctx.clearRect(0,0,c.width,c.height);
        for(const st of stars){
          ctx.globalAlpha = 0.5 + Math.sin((t+st.x*0.01)*st.s)*0.5;
          ctx.beginPath(); ctx.arc(st.x, st.y, st.r, 0, Math.PI*2); ctx.fillStyle = '#fff'; ctx.fill();
        }
        t+=0.02; requestAnimationFrame(anim);
      })();
    }

    // Notificações + som via WebAudio
    function notify(msg){
      const n = document.createElement('div'); n.className='note'; n.textContent = msg; el.notify.appendChild(n);
      try {
        const ctx = new (window.AudioContext||window.webkitAudioContext)();
        const o = ctx.createOscillator(); const g = ctx.createGain();
        o.type='sine'; o.frequency.value = 880; o.connect(g); g.connect(ctx.destination);
        g.gain.setValueAtTime(0.0001, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.12, ctx.currentTime+0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.25);
        o.start(); o.stop(ctx.currentTime+0.26);
      } catch(e) {}
      setTimeout(()=>{ n.remove(); }, 2600);
    }

    // ===================== 4) CITAÇÃO + BIMESTRE =====================
    function renderQuote(){
      const q = appData.quotes[Math.floor(Math.random()*appData.quotes.length)];
      el.quote.textContent = '“'+q+'”';
    }
    function renderBimester(){
      const start = new Date(appData.bimesterStartDate+'T00:00:00');
      const end   = new Date(appData.bimesterEndDate+'T23:59:59');
      const now = new Date();
      const total = end - start; const done = Math.min(Math.max(now - start, 0), total);
      const pct = Math.round((done/total)*100);
      const daysRemaining = Math.max(0, Math.ceil((end - now) / (1000 * 60 * 60 * 24)));
      el.bimBar.style.width = pct+'%';
      el.bimLabel.textContent = `${pct}% (${daysRemaining} dias restantes)`;
      el.bimBar.parentElement.title = `Progresso do bimestre. Faltam ${daysRemaining} dias.`;
    }

    // ===================== 5) AVISO + REAÇÕES =====================
    function renderAnnouncement(){
      const a = appData.announcement; const container = el.announce;
      container.innerHTML = `
        <button class="close-x" id="xAnn">×</button>
        <h2>${a.title}</h2>
        <p style="margin:0;color:var(--text-secondary)">${a.message}</p>
        <div class="reactions" id="reax"></div>`;
      document.getElementById('xAnn').onclick = ()=> container.remove();
      const emojis = ['👍','🔥','🤔'];
      const r = document.getElementById('reax');
      r.innerHTML = emojis.map(e => {
        const key = `rx-${a.id}-${e}`; const on = localStorage.getItem(key)==='1';
        return `<button class="react ${on?'active':''}" data-k="${key}">${e}</button>`;
      }).join('');
      r.querySelectorAll('.react').forEach(btn=>btn.onclick = ()=>{
        const k = btn.dataset.k; const on = localStorage.getItem(k)==='1';
        if(on){ localStorage.removeItem(k); btn.classList.remove('active'); }
        else { localStorage.setItem(k,'1'); btn.classList.add('active'); particle(btn); }
      });
    }
    function particle(target){
      for(let i=0;i<14;i++){
        const p = document.createElement('span');
        const s = Math.random()*6+4; const a = Math.random()*Math.PI*2; const d = Math.random()*48+22;
        p.style.cssText = `position:absolute;left:50%;top:50%;width:${s}px;height:${s}px;border-radius:50%;background:var(--accent-1);transform:translate(-50%,-50%);opacity:.9;`;
        target.style.position='relative'; target.appendChild(p);
        p.animate([
          { transform:'translate(-50%,-50%) scale(1)', opacity:.9 },
          { transform:`translate(${x}px, ${y}px) scale(0)`, opacity:0 }
        ], { duration:600, easing:'ease-out' }).onfinish = ()=> p.remove();
      }
    }

    // ===================== 6) CALENDÁRIO =====================
    function renderCalendar(m, y){
      el.calendar.innerHTML = '';
      const first = new Date(y, m, 1); const last = new Date(y, m+1, 0);
      const days = ['Dom','Seg','Ter','Qua','Qui','Sex','Sáb'];
      const months = ['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
      const head = document.createElement('div'); head.className='cal-head';
      head.innerHTML = `<button id="prev">‹</button><strong>${months[m]} ${y}</strong><button id="next">›</button>`;
      el.calendar.appendChild(head);
      head.querySelector('#prev').onclick = ()=>{ state.month--; if(state.month<0){state.month=11; state.year--;} renderCalendar(state.month,state.year)};
      head.querySelector('#next').onclick = ()=>{ state.month++; if(state.month>11){state.month=0; state.year++;} renderCalendar(state.month,state.year)};

      const grid = document.createElement('div'); grid.className='cal-grid';
      days.forEach(d=>{ const dv = document.createElement('div'); dv.className='cal-day'; dv.textContent=d; grid.appendChild(dv) });
      const startIdx = first.getDay(); const prevLast = new Date(y,m,0).getDate();
      for(let i=startIdx;i>0;i--){ const dv = document.createElement('div'); dv.className='cal-date'; dv.style.opacity=.35; dv.textContent = prevLast - i + 1; grid.appendChild(dv);} 
      for(let d=1; d<=last.getDate(); d++){
        const dv = document.createElement('div'); dv.className='cal-date'; dv.textContent=d;
        const thisDate = new Date(y,m,d); const iso = toISO(thisDate);
        if (d===state.today.getDate() && m===state.today.getMonth() && y===state.today.getFullYear()) dv.classList.add('today');
        if (d===state.selected.getDate() && m===state.selected.getMonth() && y===state.selected.getFullYear()) dv.classList.add('selected');
        if (appData.events[iso]){ dv.classList.add('has-events'); if(appData.events[iso].some(e=>e.type==='Feriado')) dv.classList.add('is-holiday'); }
        dv.onclick = ()=>{ state.selected = thisDate; renderCalendar(state.month,state.year); renderDay(thisDate); };
        grid.appendChild(dv);
      }
      el.calendar.appendChild(grid);
    }

    function renderDay(date){
      const iso = toISO(date); const evs = appData.events[iso]||[];
      const today = new Date(); today.setHours(0,0,0,0);
      const isPast = date < today;
      el.dayEvents.innerHTML = evs.length ? evs.map(e=>`<div class="event ${isPast ? 'is-past' : ''}"><span class="etype ${e.type}">${e.type}</span><span>${e.title}</span></div>`).join('') : '<p style="color:var(--text-secondary); text-align:center;">Nenhum evento para este dia.</p>';
      
      el.dayEvents.classList.add('reloading');
      setTimeout(() => el.dayEvents.classList.remove('reloading'), 600);

      renderLessons(date);
    }

    // Busca calendário
    const nowForSearch = new Date();
    nowForSearch.setHours(0,0,0,0);
    const allEventsAndAssignments = [
      ...Object.entries(appData.events).flatMap(([date, arr]) => arr.map(x=>({ ...x, date }))),
      ...appData.assignments.filter(a=>a.date).map(a=>({ type:'Trabalho', title:`Entrega de ${a.title}`, date:a.date }))
    ];
    const searchable = allEventsAndAssignments.filter(item => {
        const itemDate = new Date(item.date + 'T00:00:00');
        return itemDate >= nowForSearch;
    });

    el.searchCal.addEventListener('input', e=>{
      const q = e.target.value.toLowerCase();
      if(q.length<2){ el.results.innerHTML=''; return; }
      const res = searchable.filter(i => i.title.toLowerCase().includes(q) || i.date.includes(q));
      el.results.innerHTML = res.map(r=>`<div class="res" data-d="${r.date}">${r.title} <small style="color:var(--text-secondary)">${new Date(r.date+'T00:00:00').toLocaleDateString()}</small></div>`).join('');
      el.results.querySelectorAll('.res').forEach(n=> n.onclick = ()=>{
        const d = new Date(n.dataset.d+'T00:00:00'); state.selected=d; state.month=d.getMonth(); state.year=d.getFullYear(); renderCalendar(state.month,state.year); renderDay(state.selected); el.searchCal.value=''; el.results.innerHTML='';
      });
    });

    // ===================== 7) AULAS (HOJE/SEMANA, FILTRO, INTERAÇÃO) =====================
    function initSubjectFilter(){
      const all = new Set();
      Object.values(appData.lessons).forEach(d => d.subjects.forEach(s=> all.add(s.name)));
      el.subjectFilter.innerHTML = '<option value="">Todas as matérias</option>' + Array.from(all).sort().map(n=>`<option value="${n}">${n}</option>`).join('');
    }

    function renderLessons(date){
      const view = el.viewMode.value; const filter = el.subjectFilter.value;
      el.lessons.innerHTML = '';
      const days = view==='hoje' ? [date.getDay()] : [1,2,3,4,5];
      let totalAulas = 0; let alertas = [];
      const isTodayView = view === 'hoje';

      days.forEach(dow => {
        const ddata = appData.lessons[dow]; if(!ddata) return;
        const list = ddata.subjects.filter(s=>!filter || s.name===filter);
        if(!list.length) return;
        list.forEach(s=>{ if(s.count && s.count>1) alertas.push(`${s.count} aulas seguidas de ${s.name}`); totalAulas += (s.count||1); });
        const title = document.createElement('div'); title.style.fontWeight='800'; title.style.margin='4px 2px'; title.textContent = ddata.day; el.lessons.appendChild(title);
        list.forEach(subj => el.lessons.appendChild(makeLessonCard(ddata.day, subj, isTodayView ? date : null)));
      });

      if(totalAulas===0){ el.lessonsSummary.textContent = 'Sem aulas filtradas.'; return; }
      const uniqueAlerts = [...new Set(alertas)];
      el.lessonsSummary.textContent = `Total: ${totalAulas} aulas${uniqueAlerts.length? ' — Avisos: '+uniqueAlerts.join('; ') : ''}`;
    }

    function makeLessonCard(dayName, subj, specificDate){
      const card = document.createElement('div');
      card.className = 'lesson-card';
      card.style.borderLeft = `4px solid var(--cor-${subj.color || 'default'})`;

      const key = `note-${dayName}-${subj.name}`;
      const saved = localStorage.getItem(key) || '';

      let importantMessage = '';
      if (specificDate && subj.name === 'Lógica' && !subj.room?.toLowerCase().includes('lab')) {
          const iso = toISO(specificDate);
          const dayEvents = appData.events[iso] || [];
          const importantEvents = dayEvents.filter(e => e.type === 'Prova' || e.type === 'Trabalho');
          if (importantEvents.length > 0) {
              importantMessage = `<div class="important-note"><strong>Atenção:</strong> ${importantEvents.map(e => e.title).join(', ')} hoje!</div>`;
          }
      }

      card.innerHTML = `
        <div class="lesson-header">
            <strong>${subj.name} ${(subj.count && subj.count > 1) ? `<span class='badge'>${subj.count}x</span>` : ''}</strong>
            ${subj.room ? `<div class="badge">Sala: ${subj.room}</div>` : ''}
        </div>
        <small class="notes-prompt">Clique para ver/editar anotações</small>
        <div class="lesson-notes">
            ${importantMessage}
            <textarea rows="4" placeholder="Anotações rápidas (salvas neste navegador)">${saved}</textarea>
            <button class="btn save-note">Salvar & Fechar</button>
        </div>`;
      
      card.addEventListener('click', () => {
          if (!card.classList.contains('is-open')) {
             card.classList.add('is-open');
          }
      });
      
      const saveBtn = card.querySelector('.save-note');
      const ta = card.querySelector('textarea');
      
      saveBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          localStorage.setItem(key, ta.value);
          notify('Anotações salvas');
          card.classList.remove('is-open');
      });

      return card;
    }

    el.viewMode.onchange = ()=> renderLessons(state.selected);
    el.subjectFilter.onchange = ()=> renderLessons(state.selected);
    el.clearNotes.onclick = ()=>{
      if(!confirm('Limpar todas as anotações visíveis?')) return;
      const filter = el.subjectFilter.value; const view = el.viewMode.value; const days = view==='hoje' ? [state.selected.getDay()] : [1,2,3,4,5];
      days.forEach(dow=>{ const ddata = appData.lessons[dow]; if(!ddata) return; ddata.subjects.forEach(s=>{ if(!filter || filter===s.name){ localStorage.removeItem(`note-${ddata.day}-${s.name}`); }}); });
      notify('Anotações limpas'); renderLessons(state.selected);
    };

    // ===================== 8) TRABALHOS (TIMELINE + PROGRESSO) =====================
    function renderAssignments(){
      el.tlPending.innerHTML=''; el.tlDone.innerHTML='';
      const now = new Date();
      const start = new Date(appData.bimesterStartDate+'T00:00:00');
      appData.assignments.forEach(a => {
        if(a.status==='done'){
          const c = document.createElement('div'); c.className='t-item done'; c.innerHTML = `<strong>${a.title}</strong><div class="days">Concluído ${a.date?('em '+new Date(a.date+'T00:00:00').toLocaleDateString()):''}</div>`; el.tlDone.appendChild(c);
          return;
        }
        const wrap = document.createElement('div'); wrap.className='t-item pending';
        let pct = 0, daysLeft = '—';
        if(a.date){
          const due = new Date(a.date+'T23:59:59');
          const total = Math.max(due - start, 1);
          const elapsed = Math.min(Math.max(now - start, 0), total);
          pct = Math.round((elapsed/total)*100);
          const diff = Math.ceil((due - now)/(1000*60*60*24));
          daysLeft = diff>=0? `${diff} dia(s) restantes` : `Atrasado`;
          if (now > due) wrap.classList.add('is-past');
          if(diff===1) notify(`⚠️ ${a.title} vence amanhã!`);
          if(diff===0) notify(`⏰ ${a.title} vence hoje!`);
        }
        wrap.innerHTML = `<strong>${a.title}</strong><div class="days">${a.date?('Prazo: '+new Date(a.date+'T00:00:00').toLocaleDateString()+' — '):''}${daysLeft}</div><div class="tbar"><span style="width:${pct}%"></span></div>`;
        el.tlPending.appendChild(wrap);
      });
    }

    // ===================== 9) MATERIAIS + BUSCAS + QUICK LINK + CV =====================
    function renderMaterials(){
      el.materials.innerHTML = appData.materials.map(m=>`<div class="mat"><span class="icon">${m.icon}</span><div><div style="font-weight:700">${m.title}</div><div style="color:var(--text-secondary)">${m.desc}</div></div></div>`).join('');
      const saved = JSON.parse(localStorage.getItem('quick-links')||'[]');
      el.quickList.innerHTML = saved.length ? saved.map(u=>`<div>🚀 <a class="link" href="${u}" target="_blank" rel="noopener noreferrer">${u}</a></div>`).join('') : '<span style="color:var(--text-secondary)">Nenhum link salvo ainda.</span>';
    }
    el.goExt.onclick = ()=>{
      const q = encodeURIComponent(el.qExt.value.trim()); if(!q) return;
      const base = el.engine.value==='scholar' ? 'https://scholar.google.com/scholar?q=' : 'https://www.youtube.com/results?search_query=';
      window.open(base+q, '_blank','noopener');
    };
    el.saveQuick.onclick = ()=>{
      const v = el.quick.value.trim(); if(!v) return; const arr = JSON.parse(localStorage.getItem('quick-links')||'[]');
      arr.unshift(v); localStorage.setItem('quick-links', JSON.stringify(arr.slice(0,8))); el.quick.value=''; renderMaterials(); notify('Link salvo');
    };
    el.cvBtn.onclick = ()=>{
      const txt = `NOME COMPLETO\nCidade – UF | (00) 00000-0000 | email@exemplo.com\nLinkedIn/GitHub: https://...\n\nOBJETIVO\nEstágio/Junior em Desenvolvimento.\n\nFORMAÇÃO\n• Curso Técnico/Ensino Médio – Escola X (2024–2026)\n\nHABILIDADES\n• HTML, CSS, JS | Git/GitHub | Figma | Trabalho em equipe\n\nPROJETOS\n• DS2A Hub – hub de estudos com calendário, tarefas e materiais.\n\nATIVIDADES/EXTRAS\n• Monitoria, eventos, voluntariado.\n`;
      const blob = new Blob([txt], {type:'text/plain'}); const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='curriculo.txt'; a.click(); URL.revokeObjectURL(url);
    };

    // ===================== 10) TABS + RELAX =====================
    el.tabs.forEach(t => t.addEventListener('click', () => {
      el.tabs.forEach(x => x.classList.remove('active'));
      t.classList.add('active');
      const targetId = 'tab-' + t.dataset.tab;
      document.querySelector('section[role="tabpanel"].active')?.classList.remove('active');
      document.getElementById(targetId)?.classList.add('active');
    }));

    el.relaxBtn.onclick = ()=>{
      document.body.classList.toggle('relax-on');
      el.app.classList.toggle('relax-on');
      if(document.body.classList.contains('relax-on')) notify('Modo Relax ativado'); else notify('Modo Relax desativado');
    };

    // ===================== 11) INIT =====================
    applyWeeklyPalette();
    autoTheme();
    renderQuote();
    renderBimester();
    renderAnnouncement();
    renderCalendar(state.month, state.year);
    renderDay(state.selected);
    initSubjectFilter();
    renderAssignments();
    renderMaterials();
    drawStars();

    // alertas iniciais de prazo curto
    (function deadlineAlerts(){
      const now = new Date(); appData.assignments.filter(a=>a.status==='pending' && a.date).forEach(a=>{
        const diff = Math.ceil((new Date(a.date+'T23:59:59')-now)/(1000*60*60*24));
        if(diff>=0 && diff<=2) notify(`⚠️ ${a.title} vence em ${diff} dia(s)`);
      });
    })();

    // Recalcular barra do bimestre diariamente
    setInterval(renderBimester, 60*60*1000);
    // Ajustar tema de hora em hora
    setInterval(autoTheme, 60*60*1000);
    // Responsivo estrelas
    window.addEventListener('resize', drawStars);
  });
  </script>
</body>
</html>

